---
import BaseLayout from '../../layouts/BaseLayout.astro';
import strings from '../../data/i18n/en.json';
import providers from '../../data/providers.json';
import plans from '../../data/plans.json';

const providerMap = new Map(providers.map((p) => [p.id, p]));
const enrichedPlans = plans.map((plan) => ({
  ...plan,
  provider: providerMap.get(plan.provider_id),
}));
const integrationTags = Array.from(
  new Set(
    plans.flatMap((plan) => Array.isArray(plan.integration_tags) ? plan.integration_tags : [])
  )
).sort();
const hasPlans = enrichedPlans.length > 0;
---
<BaseLayout lang="en" title="HostStack - Compare" strings={strings}>
  <section class="card">
    <h1 class="text-3xl font-display uppercase tracking-[0.1em]">Compare</h1>
    <p class="mt-3 text-ink/70">Compare hosting offers by the criteria you care about.</p>
    <div class="mt-6 grid gap-4 md:grid-cols-3">
      <label class="text-sm">
        <span class="block text-xs uppercase tracking-[0.2em] text-ink/60">Integration</span>
        <input id="filter-integration" type="text" placeholder="e.g. edge, git" class="mt-2 w-full rounded-xl border border-ink/10 px-3 py-2" />
      </label>
      <label class="flex items-center gap-3 text-sm">
        <input id="filter-ssl" type="checkbox" class="h-4 w-4" />
        SSL only
      </label>
      <label class="text-sm">
        <span class="block text-xs uppercase tracking-[0.2em] text-ink/60">Sort</span>
        <select id="sort-select" class="mt-2 w-full rounded-xl border border-ink/10 px-3 py-2">
          <option value="price">Price</option>
          <option value="storage">Storage</option>
          <option value="traffic">Traffic</option>
        </select>
      </label>
    </div>
    {integrationTags.length > 0 && (
      <div class="mt-4 flex flex-wrap gap-2 text-xs text-ink/70">
        {integrationTags.map((tag) => (
          <span class="rounded-full border border-ink/10 px-3 py-1" key={tag}>{tag}</span>
        ))}
      </div>
    )}
  </section>

  <section class="mt-8 card">
    <h2 class="text-lg font-semibold">Results</h2>
    {!hasPlans && (
      <p class="mt-4 text-ink/70">{strings.empty_plans}</p>
    )}
    {hasPlans && (
      <div class="mt-4 overflow-x-auto">
        <table class="min-w-full text-sm" id="plans-table">
          <thead>
            <tr class="text-left uppercase text-xs tracking-[0.2em] text-ink/60">
              <th class="pb-3">Provider</th>
              <th class="pb-3">Plan</th>
              <th class="pb-3">Price</th>
              <th class="pb-3">Storage</th>
              <th class="pb-3">Traffic</th>
              <th class="pb-3">Domains</th>
              <th class="pb-3">SSL</th>
              <th class="pb-3">Integration</th>
            </tr>
          </thead>
          <tbody>
            {enrichedPlans.map((plan) => (
              <tr
                class="border-t border-ink/10"
                data-price-eur={plan.price_eur ?? ''}
                data-price-usd={plan.price_usd ?? ''}
                data-storage={plan.storage_gb ?? ''}
                data-traffic={plan.traffic_gb ?? ''}
                data-domains={plan.domains ?? ''}
                data-ssl={plan.ssl ? 'true' : 'false'}
                data-integration={(plan.integration_tags || []).join(',')}
              >
                <td class="py-3 pr-4 font-semibold">
                  {plan.provider?.slug ? (
                    <a class="hover:underline" href={`/en/providers/${plan.provider.slug}`}>
                      {plan.provider?.name || plan.provider_id}
                    </a>
                  ) : (
                    plan.provider?.name || plan.provider_id
                  )}
                </td>
                <td class="py-3 pr-4">{plan.plan_name}</td>
                <td class="py-3 pr-4">
                  <span class="price" data-eur={plan.price_eur ?? ''} data-usd={plan.price_usd ?? ''}></span>
                </td>
                <td class="py-3 pr-4">{plan.storage_gb ?? '-'} GB</td>
                <td class="py-3 pr-4">{plan.traffic_gb ?? '-'} GB</td>
                <td class="py-3 pr-4">{plan.domains ?? '-'}</td>
                <td class="py-3 pr-4">{plan.ssl ? 'Yes' : 'No'}</td>
                <td class="py-3 pr-4">{(plan.integration_tags || []).join(', ') || '-'}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    )}
  </section>

  <script>
    const table = document.getElementById('plans-table');
    const integrationInput = document.getElementById('filter-integration');
    const sslCheckbox = document.getElementById('filter-ssl');
    const sortSelect = document.getElementById('sort-select');

    function formatPrice(row) {
      const currency = document.documentElement.dataset.currency || 'eur';
      const price = row.dataset[currency === 'eur' ? 'priceEur' : 'priceUsd'];
      const priceCell = row.querySelector('.price');
      if (!priceCell) return;
      if (!price) {
        priceCell.textContent = '-';
        return;
      }
      priceCell.textContent = currency === 'eur' ? `â‚¬${price}` : `$${price}`;
    }

    function applyFilters() {
      if (!table) return;
      const rows = Array.from(table.querySelectorAll('tbody tr'));
      const integrationFilter = integrationInput?.value.toLowerCase() || '';
      const sslOnly = sslCheckbox?.checked;

      rows.forEach((row) => {
        const integration = row.dataset.integration?.toLowerCase() || '';
        const ssl = row.dataset.ssl === 'true';
        const matchesIntegration = integrationFilter === '' || integration.includes(integrationFilter);
        const matchesSsl = !sslOnly || ssl;
        row.style.display = matchesIntegration && matchesSsl ? '' : 'none';
        formatPrice(row);
      });
    }

    function sortRows() {
      if (!table) return;
      const rows = Array.from(table.querySelectorAll('tbody tr'));
      const key = sortSelect?.value || 'price';
      const dataKey = key === 'price' ? 'priceEur' : key;
      rows.sort((a, b) => {
        const av = parseFloat(a.dataset[dataKey] || '0');
        const bv = parseFloat(b.dataset[dataKey] || '0');
        return av - bv;
      });
      rows.forEach((row) => table.querySelector('tbody').appendChild(row));
    }

    window.addEventListener('currency-change', applyFilters);
    integrationInput?.addEventListener('input', applyFilters);
    sslCheckbox?.addEventListener('change', applyFilters);
    sortSelect?.addEventListener('change', () => {
      sortRows();
      applyFilters();
    });

    sortRows();
    applyFilters();
  </script>
</BaseLayout>
